<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<link rel='icon' href='libs/images/marker-icon.png' type='image/ico' />
    <meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	
	<!-- Biblioteca Básica: Leaflet-->
    <link rel="stylesheet" href="libs/leaflet.css"/>
	<!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14=" crossorigin=""/> -->

	<!-- Make sure you put this AFTER Leaflet's CSS -->
	<script src="libs/leaflet.js"></script>
	<!-- <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js" 
	integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg=" crossorigin=""></script> -->

	<!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
		integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
		crossorigin=""/> -->
	 <!-- Make sure you put this AFTER Leaflet's CSS -->
	 <!-- <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
	 	integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
	 	crossorigin=""></script> --> 

	<!-- Draw-->
	<script src= "https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw-src.js"></script>
	<link rel="stylesheet" href= "https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.css">
	<script src= "https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.js"></script>
	
	<!-- Slide menu-->
	<link rel="stylesheet" href="libs/slide_menu/SlideMenu.css" />
	<script src="libs/slide_menu/SlideMenu.js"></script>
	
	<!-- GeoCoder-->
	<link rel="stylesheet" href="libs/Control/Control.OSMGeocoder.css"/>
	<script src="libs/Control/Control.OSMGeocoder.js"></script>
	
	<!-- Search adicionado -->
	<link rel="stylesheet" href="libs/leaflet-search.css"/>
	<script src="libs/leaflet-search.js"></script>
	
	<!-- Overview-->
	<link rel="stylesheet" href="libs/overview/MiniMap.css" />
	<script src="libs/overview/MiniMap.js"></script>
 
	<!-- Localisation-->
	<link rel="stylesheet" href="libs/Control/L.Control.Locate.min.css" />
    <script src="libs/Control/L.Control.Locate.js"></script>
	
	<!-- Mouse position-->
	<link rel="stylesheet" href="libs/Control/L.Control.MousePosition.css" />
    <script src="libs/Control/L.Control.MousePosition.js"></script>

	<!-- MapCenter Coord -->
	<link rel="stylesheet" href="libs/MapCenterCoord/src/L.Control.MapCenterCoord.css" />
	<script src="libs/MapCenterCoord/src/L.Control.MapCenterCoord.js"></script>
	
	<!-- Navigation Bar-->
    <link rel="stylesheet" href="libs/NavBar/NavBar.css"/>
	<script src="libs/NavBar/NavBar.js"></script>
	
	<!-- Font está causando lentidão -->
	<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
	
	<!-- FullScreen -->
	<script src="libs/Control/FullScreen/Control.FullScreen.js"></script>
	
	<!-- jquery-->
	<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>

	<script src="libs/Leaflet-WMS..js"></script>
	<script src="libs/spin.js"></script>

	<script  src = "libs/leaflet.featuregroup.subgroup.js" > </script>
	
	<!-- Bing Map js-->
	<script src="libs/leaflet-bing-layer.js"></script>

	<!-- <link ref="@(Url.Content(" path of css"))" rel="stylesheet">
	<script src="@(Url.Content(" path of js"))" type="text/javascript"></script> -->

	<style>
		body {
			padding: 0;
			margin: 0;
		}
	
		html,
		body,
		#map {
			height: 100%;
			width: 100%;
		}
	
		#textofooter,
		#textotop {
			z-index: 1;
			/* Faz com que fique sobre todos os elementos da página */
		}
		#textotop {
			position: absolute;
			top: 15px;}

		@media only screen and (min-width: 801px) {
			#btn {
			top: 90px;
			}
			.leaflet-container .leaflet-control-mouseposition ,
			.leaflet-draw {
				visibility: visible;
			}
			#textotop {
			left: 55px;
			font-size: 13pt;
			}
			 
		} 
		@media only screen and (max-width: 800px) {
			#btn {
			top: 110px;
			}
			.leaflet-container .leaflet-control-mouseposition ,
			.leaflet-draw {
				visibility: hidden;
			}
			#textotop {
			left: 12%;
			font-size: 11pt;
			}
		} 
	
		#btn {
			position: absolute;
			right: 10px;
			
			z-index: 1000;
			background: white;
			border: none;
			border-radius: 4px;
			box-shadow: 0 1px 5px rgb(0 0 0 / 65%);
		}
	
		.leaflet-popup-content {
			font-size: 10pt;
		}
	
		.leaflet-container .leaflet-control-attribution,
		.leaflet-container .leaflet-control-scale {
			font-size: 13px;
		}
	</style>
	<style type="text/css">
		/* #map { width: 700px; height: 433px; } */
		.fullscreen-icon { background-image: url(libs/Control/FullScreen/icon-fullscreen.png); }
		.leaflet-retina .fullscreen-icon { background-image: url(libs/Control/FullScreen/icon-fullscreen-2x.png); background-size: 26px 26px; }
		/* one selector per rule as explained here : http://www.sitepoint.com/html5-full-screen-api/ */
		.leaflet-container:-webkit-full-screen { width: 100% !important; height: 100% !important; z-index: 99999; }
		.leaflet-container:-ms-fullscreen { width: 100% !important; height: 100% !important; z-index: 99999; }
		.leaflet-container:full-screen { width: 100% !important; height: 100% !important; z-index: 99999; }
		.leaflet-container:fullscreen { width: 100% !important; height: 100% !important; z-index: 99999; }
		.leaflet-pseudo-fullscreen { position: fixed !important; width: 100% !important; height: 100% !important; top: 0px !important; left: 0px !important; z-index: 99999; }
	</style>

	<title>Mapeamento de Obras SMO </title>
</head>
<body>
	<!-- div para conter os textos sobre o mapa-->
	<div id="textotop">
		Secretaria Municipal de Obras - SMO </br>
		Mapa de Obras em execução </br>
	</div>

	<!-- div para conter o corpo do mapa -->
    <div id="map"></div>
	<button id="btn">Camadas</button>
    <script>
	
		/* Camadas de base */
		var OpenStreetMap = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
				subdomains: ['a', 'b', 'c'],
				opacity: .6,
				maxZoom: zmax,
		});
			
		// var WorldImagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
		// 	subdomains: ['a', 'b', 'c'],
		// 	maxZoom: zmax,
		// });

		var BING_KEY = 'AuhiCJHlGzhg93IqUH_oCpl_-ZUrIE6SPftlyGYUvr9Amx5nzA-WqGcPquyFZl4L'
		var WorldImagery = L.tileLayer.bing({
				bingMapsKey: BING_KEY, 
				imagerySet:'AerialWithLabels',
		});

		var googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
			subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
			maxZoom: zmax,
		});

		var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
			subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
			maxZoom: zmax,
		});

		var WorldImagery3 = L.tileLayer({},{
			});

		/* Configuração gerais do mapa */
		var zmax = 18; // define o nível máximo de zoom
		var map = L.map('map', {
				layers: [OpenStreetMap], /// mapa fundo de base
				center: [2.81886,-60.72128],/// coordenadas
				zoom: 13,	//// zoom default. Quando menor, mais altitude..
				maxZoom: zmax,
				Srs : L.CRS.EPSG31974,
				fullscreenControl: true,
				fullscreenControlOptions: { // optional
				title:"Show me the fullscreen !",
				titleCancel:"Exit fullscreen mode"
			}
			});

		/* Crédito às fontes de dados */ 
		map.attributionControl.addAttribution(' Secretaria Municipal de Obras - SMO - developed by H. Roger - Observatório/SMO');
		
		///// Definindo os layers de base		
		var baseLayers = {
			"Open Street Map": OpenStreetMap,
			"Bing Satélite": WorldImagery,
			'Google Hybrid': googleHybrid,
			'Google Satelite': googleSat,
			'Ocultar Mapa': WorldImagery3,
		};

		// var servidor = 'http://localhost:8080/geoserver/SMO/wms';		 // local
		// var servidor = 'http://192.168.15.113:8080/geoserver/SMO/wms'; // pc server
		//	var servidor = 'http://192.168.15.159:8080/geoserver/SMO/wms'; // note server
		var servidor = 'http://18.228.19.78:8080/geoserver/SMO/wms';		 // servidor aws roger
		
		///// Buscar layers a partir do Geoserver (formato WMS)
		var bairros = L.tileLayer.wms(servidor,{
			layers: 'SMO:bairros' ,
			transparent: 'true',
			format: 'image/png',
			version: '1.3.0',
			maxZoom: zmax,
			// crossOrigin: 'anonymous',
		});	

		var infraestrutura = L.tileLayer.wms(servidor,{
			layers: 'SMO:v_obrasinfra' ,
			name: 'Obras de Infraestrutura',
			transparent: 'true',
			format: 'image/png',
			version: '1.3.0',
			maxZoom: zmax,
			crossOrigin: 'anonymous',
			// datavar: '',
			// layerName: 'infraestrutura',
			//pane: 'pane_ObrasInfra',
			// onEachFeature: pop_ObrasInfra,
		}).addTo(map);

		var linhasParqueRioBranco = L.tileLayer.wms(servidor,{
			layers: 'SMO:linhasParqueRioBranco' ,
			name: "Linhas Parque Rio Branco",
			transparent: 'true',
			format: 'image/png',
			version: '1.3.0',
			opacity: '1',
			maxZoom: zmax,
			crossOrigin: 'anonymous',
		}).addTo(map);
		
		var obrascivis_poligonos = L.tileLayer.wms(servidor,{
			layers: 'SMO:obrascivis' ,
			name: "Obras de Construção Civil.",
			transparent: 'true',
			format: 'image/png',
			version: '1.3.0',
			opacity: '.3',
			maxZoom: zmax,
			crossOrigin: 'anonymous',
		}).addTo(map);	

		var obrascivis = L.tileLayer.wms(servidor,{
			layers: 'SMO:v_obrascivis',
			name: "Obras de Construção Civil",
			transparent: 'true',
			format: 'image/png',
			version: '1.3.0',
			crossOrigin: 'anonymous',
			// styles: 'SMO:ObrasCivis2021',
		});
		
		var municipioBV = L.tileLayer.wms(servidor, {
			layers: 'SMO:boavista',
			transparent: true,
			format: 'image/png',
			version: '1.3.0',
			crossOrigin: 'anonymous',
		});

		// var obrascivisPontos = L.GeoJSON(servidor,{
		// 	layers: 'SMO:v_obrascivis',
		// 	name: "Obras de Construção Civil",
		//  outputFormat : 'json',
			
		// });	
		
		///// Grupo de Layers
		var civilsubgrupo = (L.layerGroup([linhasParqueRioBranco,  obrascivis_poligonos, obrascivis])).addTo(map);
		// var marker = L.marker(obrascivis).addTo(map);
		var overlays = {
			'Município de Boa Vista': municipioBV,
			'Bairros': bairros,
			'Infraestrutura viária': infraestrutura, 
			'Obras Civis': civilsubgrupo,
		};

		bairros.addTo(map);
		
		// map.getPane('panel_points').style.pointerEvents = 'none';

		/////// Criando painéis das camadas
		// map.createPane('pane_ObrasInfra');
		// map.getPane('pane_ObrasInfra').style.zindez = 400;
		// // As camadas neste painel não são interativas e não obscurecem eventos de mouse / toque
		// map.getPane('pane_ObrasInfra').style.pointerEvents='true';

		// var layer_ObrasInfra = L.geoJson(infraestrutura).addTo(map);

		// 	layer_ObrasInfra.eachLayer(function(layer){
		// 	layer.bindPopup(layer.p.rua);
		// });



		// var marker = new L.marker([39.5, -77.3], { opacity: 0.01 }); //opacity may be set to zero
		// 	marker.bindTooltip("My Label", { permanent: true, className: "my-label", offset: [0, 0] });
		// 	marker.addTo(map);
		// O estilo CSS pode ser aplicado à classe da mesma maneira quue antes
		// 		.my - label {
		// 		position: absolute;
		// 		width: 1000px;
		// 		font - size: 20px;
		// 		}

		// Resolvido, eu estava usando uma das propriedades do recurso como texto, tinha que acrescentar 
		// um .toString()no final. marker.bindTooltip(feature.properties['prabhag_number'].toString(), {...
		
		//// Add the Find to the map 
		var osmGeocoder = new L.Control.OSMGeocoder();
        map.addControl(osmGeocoder);
				
		///// Add the Overview to the map 
        var osm2 = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
		var miniMap = new L.Control.MiniMap(osm2, { toggleDisplay: true }).addTo(map);
		
		///// Add the scale control to the map
		L.control.scale().addTo(map);
			
		///// Add the Navigation Bar to the map 
		L.control.navbar({position: 'topleft'}).addTo(map);
		
		///// Add the geolocate control to the map
		// L.control.locate().addTo(map);
		
		//// Add MapCenterCoord
		// L.control.mapCenterCoord({
		// 		latlngFormat: 'DM',
		// 		template: '<b>ETRS89 UTM31N</b><br>x:{x} y:{y}', //exemplo
		// 		projected: true,
		// 		onMove: true,
		// 		// formatProjected: '##.###0,'
		// 	}).addTo(map);

		///// Add the mouse position to the map 
		L.control.mousePosition().addTo(map);

		///// Add the Search control to the map
		// L.control.Search().addTo(map);
		
		///// Add the draw feature to the map
		var drawnItems = new L.FeatureGroup();
		map.addLayer(drawnItems);

		///// config draw feature
		var drawControl = new L.Control.Draw({
			position: 'topleft',
			draw: {
				polygon: {
					shapeOptions: {color: 'purple'},
					allowIntersection: false,
					drawError: {color: 'orange',timeout: 1000},
					showArea: true,
					metric: false,
					repeatMode: true
				},
				polyline: {
					shapeOptions: {color: 'red'},
				},
				rect: {
					shapeOptions: {color: 'green'},
				},
				circle: {
					shapeOptions: {color: 'steelblue'},
				},
				marker: true
				},
						edit: {
						  featureGroup: drawnItems,
						  remove: true
					}
				});
		map.addControl(drawControl);
		map.on('draw:created', function (e) {
			var type = e.layerType,
				layer = e.layer;
			drawnItems.addLayer(layer);
		});
		
		/////////// slide menu com legendas das camadas
		var div = L.DomUtil.create('div', 'info-legend');	
			var titre1 = 'Obras de Infraestrutura';
			contents1 = div.innerHTML = '<br><img src="'+servidor 
					+'?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=SMO:v_obrasinfra" </img><br>';
			
			var titre2 = 'Obras Civis';
			contents2 = div.innerHTML = '<br><img src="' + servidor 
					+ '?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=60&HEIGHT=60&LAYER=SMO:v_obrascivis" </img><br>';

			var titre3 = 'Bairros';
			contents3 = div.innerHTML = '<br><img src="' + servidor 
					+ '?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=SMO:bairros" </img><br>';

			// var titre3 = 'lim_inter_district';
			// contents3 = div.innerHTML = '<br><img src="http://localhost:8050/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=hta_zaghouan:limite_inter_district" </img><br>';
			
			var slideMenu = L.control.slideMenu('', {position: 'topright', delay: '5'}).addTo(map);
			slideMenu.setContents(titre1 + contents1 + titre2 + contents2 + titre3 + contents3  );
		

		///// criando um controle de camadas de base + couches geoserver
		L.control.layers(baseLayers, overlays, civilsubgrupo, { collapsed: false }).addTo(map);
			$('.leaflet-control-layers').hide();
			$('.leaflet-control-layers').css('top', '30px');
			btn.onclick = function () {
				$('.leaflet-control-layers').toggle();
			}
		
		///////////////////////////////////////////////////////

		// Retrieve document's body & create new spinner.
		var body = document.getElementsByTagName('body')[0];
		var spinner = new Spinner({
			lines: 15, // The number of lines to draw.
   			length: 20, // The length of each line.
			width: 15, // The line thickness.
			radius: 50, // The radius of the inner circle.
			corners: 1, // Corner roundness (0..1).
			rotate: 0, // The rotation offset.
			direction: 1, // 1: clockwise, -1: counterclockwise.
			color: '#000', // #rgb or #rrggbb or array of colors.
			speed: 1, // Rounds per second.
			trail: 50, // Afterglow percentage.
			shadow: false, // Whether to render a shadow.
			hwaccel: false, // Whether to use hardware acceleration.
			className: 'spinner', // The CSS class to assign to the spinner.
			zIndex: 2e9, // The z-index (defaults to 2000000000).
			top: '50%', // Top position relative to parent.
			left: '50%' // Left position relative to parent.
		});

		//////////// handle click on map. / Manipulando o clique no mapa
		var wmsLayers =[infraestrutura, obrascivis]; // conjunto de camadas para buscar dados

		map.on('click', function (e) {
			var wmsLayersCount = wmsLayers.length;
			if (wmsLayersCount > 0) {
				spinner.spin(body); // Start spinner na tela .
			};

			var fullfilledRequestsCount = 0;
			var popupContent = '<u><b>Informações:</b></u><br>';
			var allFeatureCount = 0;

			 // Send 'GetFeatureInfo' requests.
			for (var i = 0; i < wmsLayersCount; i++) {
				var wmsLayer = wmsLayers[i]; // cria lista de layers do local
				wmsLayer.getBoundingBox({
					done: function (boundingBoxes, xhr) {
						console.log(boundingBoxes);
					},
					fail: function (errorThrown, xhr) {
						console.log(errorThrown);
					},
					always: function () {
					}
				});
				wmsLayer.getFeatureInfo({
					latlng: e.latlng, featureCount: 5,
					done: function (featuresCollection, xhr) {
						var result = createMarkingWhenDone(this, featuresCollection);
						popupContent += result.popupContent;
						allFeatureCount += result.allFeatureCount;
						console.log('getFeatureInfo Succeed: ', featuresCollection);
					},
					fail: function (errorThrown, xhr) {
						popupContent += createMarkingWhenError(this, errorThrown);
						console.log('getFeatureInfo Failed: ', errorThrown);
					},
					always: function () {
						fullfilledRequestsCount++;
						console.log('getFeatureInfo Finished');
						// Stop spinner.
						if (fullfilledRequestsCount === wmsLayersCount) {
							var finalPopupContent = createFinalMarking(wmsLayersCount, allFeatureCount, popupContent);
							spinner.stop(); // Finaliza spinner
							allFeatureCount==0 ? finalPopupContent='Sem informações': finalPopupContent;
							new L.Popup({	// cria o elemento popup e dimensões
								minWidth: 150,
								maxWidth: 350,
								maxHeight: 400
							})
							.setLatLng(e.latlng) // localização latlng
							.setContent(finalPopupContent + '</br>' + e.latlng) // atribii o conteúdo Finalmarking
							.openOn(map) // adiciona ao mapa
						};
         			}
        		});
			}
		});


		// Helper methods. Métodos auxiliares do popup..
		function createMarkingWhenDone(_this, _featuresCollection) {
			var features = _featuresCollection.features;
			var featuresCount = features.length;
			var _popupContent = '';
			
			// Layer info.
			// _popupContent += '<b>' + _this.options.name;
			// _popupContent += '</b> <span>(Layer\'s feature count: ' + featuresCount + ')</span><br>';
			
			if (featuresCount > 0) {
				for (var j = 0; j < featuresCount; j++) {
					var feature = features[j];
					var featureNumber = j + 1;
					var p = feature.properties;
					var propertiesNames = Object.keys(p) || [];

					// Object info. Layer\'s property count
					// _popupContent += '<b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
					// _popupContent += 'Objeto Nº ' + featureNumber;
					// _popupContent += '</b> <span>Quantidade de propriedades: ' + propertiesNames.length + ')</span><br>';

					// for (var q = 0; q < propertiesNames.length; q++) {
					// 	var propertiesName = propertiesNames[q];
					// 	var number = q + 1;

						// Object properties.
						// _popupContent += '<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(';
						// _popupContent += number + ') ' + propertiesName;
						// _popupContent += ': ' + properties[propertiesName] + '</span><br>';

					var obra = !p.obra ? "" : "<br> <b>" + p.obra + '</b>';

					var fasenome = !fasenome ? '' : p.fasenome;
					var trecho = !p.trecho ? "" : "<br> Trecho: <b>" + p.trecho + '</b>';
					var status = !p.status ? "<br> Status: "  : "<br> Status: <b>" + p.status + "</b>";
					// var dconclusao = !p.dconclusao
					
					var pavokano = !p.pavokano ? '-' : p.pavokano ;
					var pavimento = !p.pavimento ? '-' : p.pavimento + " m " + "</b>conclusão: <b>";	

					var recapokano = !p.recapokano ? '-' : p.recapokano;
					var recap = !p.recap ? '-': p.recap + " m " + "</b>conclusão: <b>";

					var drenokano = !p.drenokano ? '-' : p.drenokano;
					var drenagem = !p.drenagem ? '-': p.drenagem  + " m " + "</b>conclusão: <b>";

					var calokano = !p.calokano ? '-' : p.calokano ;
					var calcada = !p.calcada ? '-' : p.calcada + " m " + "</b>conclusão: <b>" ;
					
					var mfokano = !p.mfokano ? '-' : p.mfokano ;
					var meiofio = !p.meiofio ? '-' : p.meiofio + " m " + "</b>conclusão: <b>" ;
					//  </b>";
					
					var valatubok = !p.valatubok ? '-' : p.valatubok;
					var vala = !p.vala ? '-' : p.vala + " m " + "</b>conclusão: <b>" ;

						_popupContent += '<b>' + _this.options.name + '</b>';
						_popupContent += '<span>';
						// Informações gerais
						_popupContent += obra;
						_popupContent += "<br> Classificação: " + p.subsetor;
						_popupContent += "<br> Processo nº: <b>" +  p.processo  + "</b>  " + fasenome + "";
						_popupContent += "<br> Empresa: <b>" +  p.nomeempresa  + "</b> ";
						_popupContent += "<br> Local: <b>" + p.rua  + '</b>';
						_popupContent += trecho;
						_popupContent += "<br> Bairro: <b>" + p.bairro  + '</b>';
						_popupContent += status;
						
						// dados dos Serviços de Infraestrutura
						var servicosinfra = "<br> <u><b>Serviços: </u> </b>" ;
						servicosinfra += "<br> Pavimentação: <b>" + pavimento  + pavokano + "</b>";;
						servicosinfra += "<br> Recapeamento: <b>" + recap  + recapokano + "</b>";
						servicosinfra += "<br> Drenagem: <b>" + drenagem  + drenokano + "</b>";
						servicosinfra += "<br> Calçada: <b>" + calcada + calokano + "</b>";
						servicosinfra += "<br> MeioFio: <b>" + meiofio + mfokano + "</b>";
							// "</b>"; 
						
						// testa se é infra e acrescenta os serviços
						_popupContent += !(p.macrosetor=='Infraestrutura') ? '': servicosinfra; 

						// paret final
						_popupContent += "<br> (codobra: " + p.codobra  + ")"; ; 
						_popupContent += "</span><br><br>";

					// }
				}
			}
			var result = {};
			result.allFeatureCount = featuresCount;
			result.popupContent = _popupContent;
			return result;
		};

		function createMarkingWhenError(_this, _errorThrown) {
			var _popupContent = '';
			// Error message.
			_popupContent += '<u><b>' + _this.options.name + ':</u></b><br>';
			_popupContent += 'Error message: \'' + _errorThrown.message + '\'<br>';
			_popupContent += '<br>'
			return _popupContent;
		};

		function createFinalMarking(_wmsLayersCount, _allFeatureCount, _popupContent) {
			var finalPopupContent = _popupContent;
			// finalPopupContent += '<u><b>Dados encontrados</b></u><br>';
			finalPopupContent += '<span>Camadas pesquisadas: ' + _wmsLayersCount + ' </span><br>';
			finalPopupContent += '<span>Objetos pesquisados: ' + _allFeatureCount + ' </span>';

			return finalPopupContent;
		};

		///////////////////////////////////////////////////////


		// Perform 'GetFeatureInfo' request - exemplo Leaflet-WMS
		// map.on('click', function (e) {
		// 	infraestrutura.getFeatureInfo({
		// 		latlng: e.latlng,
		// 		done: function (featureCollection) {
		// 			console.log('getFeatureInfosucceed: ', featureCollection);
		// 		},
		// 		fail: function (errorThrown) {
		// 			console.log('getFeatureInfo failed: ', errorThrown);
		// 		},
		// 		always: function () {
		// 			console.log('getFeatureInfo finished');
		// 		}
		// 	});
		// });

		// definimos uma função de estilo para nossa camada
			
		//////////////////////

		// Adicionando alguma interação ao passar o maouse (falta ajustar..)
		// var highlightLayer;
        // function highlightFeature(e) {
        //     highlightLayer = e.target;

		// 	layer.setStyle({
		// 		weight: 5,
		// 		color: '#666',
		// 		dashArray: '',
		// 		fillOpacity: 0.7
		// 	});

		// 	if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
		// 		layer.bringToFront();
		// 	}

        //     // if (e.target.feature.geometry.type === 'LineString') {
        //     //   highlightLayer.setStyle({
        //     //     color: '#ffff00',
        //     //   });
        //     // } else {
        //     //   highlightLayer.setStyle({
        //     //     fillColor: '#ffff00',
        //     //     fillOpacity: 1
        //     //   });
        //     // }
        //     // highlightLayer.openPopup();
        // };

		// var geojsonMarkerOptions = {
		// 	radius: 8,
		// 	fillColor: "#ff7800",
		// 	color: "#000",
		// 	weight: 1,
		// 	opacity: 1,
		// 	fillOpacity: 0.8
		// };


		// /// Popup obrascivis
		// var owsrootUrl = '' + servidor;
		// var defaultParameters2 = {
		// 		service: 'WFS', 
		// 		version: '2.0',
		// 		request: 'GetFeature',
		// 		typeName: 'SMO:v_obrascivis',
		// 		outputFormat: 'json',
		// 		format_options: 'callback:getJson',
		// 		SrsName : 'EPSG:31974',
		// };

		// var parameters2 = L.Util.extend(defaultParameters2);
		// var URL = owsrootUrl + L.Util.getParamString(parameters2);
		// console.log(URL);
		// var WFSLayer = null;
		// var ajax = $.ajax({
		// 		url: URL,
		// 		dataType: 'json',
		// 		jsonpCallback: 'getJson',
		// 		success : function (response) {
		// 			console.log( response),
		// 			WFSLayer = L.geoJson(response,{
		// 				// style: function (feature) {
		// 				pointToLayer: function (feature, latlng) {
        // 					return L.circleMarker(latlng, geojsonMarkerOptions);
		// 					// return { stroke: false, fillColor: 'FFFFFF', fillOpacity: 0 };
		// 				},
		// 				// onEachFeature: function (feature, layer) {
		// 				// 	popupOptions = { maxWidth: 250 },
		// 				// 	layer.bindPopup("<b>Obrea:</b> " + feature.properties.obra
		// 				// 		, popupOptions);
									
		// 				// }
		// 			}).addTo(map);
					
		// 		}
		// 	});


			////////////////////////////////////

		// var geojson_bairro = L.geoJson(bairros, {
		// 		// style: style,
		// 		onEachFeature: onEachFeature
		// 	}).addTo(map);

		// //  acontece em mouseout:
		// function resetHighlight(e) {
		// 		geojson_bairro.resetStyle(e.target);
		// 	};
		// // definir um click ouvinte que amplia 
		// function zoomToFeature(e) {
		// 		map.fitBounds(e.target.getBounds());
		// 	};
		// // adicionar os ouvintes em nossas camadas 
		// function onEachFeature(feature, layer) {
		// 	layer.on({
		// 		mouseover: highlightFeature,
		// 		mouseout: resetHighlight,
		// 		click: zoomToFeature
		// 	});
		// }

		


        // add the listeners 
		// function pop_ObrasInfra(feature,layer){
		// 	layer.on({
		// 		mouseover:highlightFeature,	
		// 	});
		// };


		/// Popup Infraestrutura
			// var owsrootUrl = servidor;
			// var defaultParameters = {
			// 	service : 'WFS',
			// 	version : '2.0',
			// 	request : 'GetFeature',
			// 	typeName : 'SMO:v_obrasinfra',
			// 	outputFormat : 'json',
			// 	format_options : 'callback:getJson',
			// 	SrsName : 'EPSG:31974',
				
			// };

			// var parameters = L.Util.extend(defaultParameters);
			// var URL = owsrootUrl + L.Util.getParamString(parameters);

			// var WFSLayer = null;

			// var ajax = $.ajax({
			// 	url : URL,
				// ---jsonp: "$jsonp", ---
				//--- dataType: "jsonp",---
				// ---dataType : 'jsonp',----
			// 	jsonpCallback : 'getJson',
			// 	success : function (response) {
			// 		WFSLayer = L.geoJson(response, {
			// 			style: function (feature) {
			// 					return {
			// 					stroke: false,
			// 					fillColor: 'FFFFFF',
			// 					fillOpacity: 0
			// 					};
			// 				},
			// 			onEachFeature: function (feature, url) {
			// 				popupOptions = {maxWidth: 600};
			// 				url.bindPopup(
			// 					"<b>Processo:</b> "  
			// 					,popupOptions);
			// 			}
			// 		}).addTo(map);
			// 	}
			// });


		//file:/C:/xxx.png
    </script>
	<script type="text/javascript">
		//Analytics
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-36489204-2']);
			_gaq.push(['_trackPageview']);	  
			(function() {
			  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; 
			  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			})();
			// document.cookie = 'cross-site-cookie=bar; SameSite=None';
	</script>
	
</body>
</html>